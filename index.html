<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MISSJO Controller</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 700px; margin: 0 auto; }
    
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header-title { color: #00d9ff; font-size: 20px; font-weight: 700; cursor: default; user-select: none; }
    .header-title .missjo { color: #ffdd00; font-size: 26px; font-weight: 800; }
    .header-title .from { color: #00d9ff; font-size: 14px; font-weight: 600; }
    .dev-badge { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: #fff; font-size: 10px; padding: 3px 8px; border-radius: 10px; margin-left: 10px; font-weight: 600; }
    .header-buttons { display: flex; gap: 8px; }
    .lang-btn {
      padding: 8px 12px; border: 2px solid transparent; border-radius: 8px;
      background: rgba(255,255,255,0.1); cursor: pointer; font-size: 18px; transition: all 0.2s;
    }
    .lang-btn:hover { background: rgba(255,255,255,0.2); }
    .lang-btn.active { border-color: #00d9ff; background: rgba(0,217,255,0.2); }
    .info-btn {
      padding: 8px 14px; border: none; border-radius: 8px;
      background: linear-gradient(135deg, #a55eea, #8854d0);
      color: white; cursor: pointer; font-size: 14px; font-weight: 600;
    }
    
    .card {
      background: rgba(22, 33, 62, 0.9); border-radius: 16px;
      padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);
    }
    .card-title {
      font-size: 14px; color: #888; text-transform: uppercase;
      letter-spacing: 1px; margin-bottom: 15px;
      display: flex; justify-content: space-between; align-items: center;
    }
    
    .status-bar { display: flex; align-items: center; justify-content: space-between; }
    .status { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4757; box-shadow: 0 0 10px #ff4757; }
    .status-dot.connected { background: #2ed573; box-shadow: 0 0 10px #2ed573; }
    
    .btn {
      padding: 12px 24px; border: none; border-radius: 10px;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-connect { background: linear-gradient(135deg, #00d9ff, #0090ff); color: #000; }
    .btn-disconnect { background: linear-gradient(135deg, #ff4757, #ff3344); color: #fff; }
    .btn-row { display: flex; gap: 10px; margin-top: 10px; }
    .btn-load-device {
      background: linear-gradient(135deg, #a55eea, #8854d0); color: #fff;
      flex: 1; padding: 15px; font-size: 14px;
    }
    .btn-save {
      background: linear-gradient(135deg, #2ed573, #1abc54); color: #000;
      flex: 1; padding: 15px; font-size: 14px;
    }
    .btn-save.unsaved { animation: pulse 1.5s infinite; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.5); }
      50% { box-shadow: 0 0 15px 5px rgba(46, 213, 115, 0.3); }
    }
    .unsaved-badge { display: inline-block; background: #ffa502; color: #000; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
    .hidden { display: none !important; }
    
    /* í”„ë¦¬ì…‹ ê·¸ë¦¬ë“œ */
    .preset-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .preset-box {
      padding: 12px 8px; border: 2px solid rgba(255,255,255,0.15); border-radius: 12px;
      background: rgba(0,0,0,0.2); cursor: pointer; text-align: center; transition: all 0.2s;
    }
    .preset-box:hover { border-color: #00d9ff; background: rgba(0,217,255,0.1); }
    .preset-box.selected { border-color: #2ed573; background: rgba(46,213,115,0.15); }
    .preset-icon { font-size: 24px; margin-bottom: 5px; }
    .preset-name { font-size: 10px; color: #aaa; }
    .preset-actions { display: flex; gap: 10px; margin-top: 15px; }
    .preset-actions .btn { flex: 1; padding: 10px; }
    .btn-load { background: linear-gradient(135deg, #00d9ff, #0090ff); color: #000; }
    
    /* ë²„íŠ¼ ê·¸ë¦¬ë“œ */
    .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .button-box {
      padding: 15px; border: 2px solid rgba(255,255,255,0.15); border-radius: 12px;
      background: rgba(0,0,0,0.2); cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .button-box:hover { border-color: rgba(255,255,255,0.3); }
    .button-box.selected { border-color: #00d9ff; background: rgba(0,217,255,0.15); }
    .button-box.virtual-active { border-color: #2ed573; background: rgba(46,213,115,0.2); transform: scale(0.97); }
    .button-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .button-number { font-size: 16px; font-weight: 700; color: #00d9ff; }
    .button-mode-badge { font-size: 12px; padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: #888; font-weight: 600; }
    .button-mode-badge.single { background: rgba(255,165,2,0.2); color: #ffa502; }
    .button-mode-badge.double { background: rgba(0,217,255,0.2); color: #00d9ff; }
    .button-info { font-size: 11px; color: #888; line-height: 1.8; }
    .button-info-row { display: flex; align-items: flex-start; gap: 5px; margin-bottom: 2px; }
    .button-info-label { color: #666; min-width: 18px; font-weight: 600; }
    .button-info-value { color: #ccc; word-break: break-word; }
    
    .virtual-hint {
      font-size: 11px; color: #2ed573; font-weight: 600;
      background: rgba(46,213,115,0.15); padding: 4px 10px; border-radius: 12px;
      animation: hintPulse 2s infinite;
    }
    @keyframes hintPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .virtual-toggle { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #888; }
    .toggle { position: relative; width: 44px; height: 24px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.2); border-radius: 24px; transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background: white; border-radius: 50%; transition: 0.3s;
    }
    .toggle input:checked + .toggle-slider { background: #2ed573; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
    
    /* ì„¤ì • */
    .mode-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .mode-btn {
      padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px;
      background: transparent; color: #888; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    #modeSingle.active { border-color: #ffa502; color: #ffa502; background: rgba(255,165,2,0.15); }
    #modeDouble.active { border-color: #00d9ff; color: #00d9ff; background: rgba(0,217,255,0.1); }
    
    .slider-group { margin: 15px 0; }
    .slider-box {
      background: rgba(0,0,0,0.4);
      border: 2px solid rgba(0,217,255,0.3);
      border-radius: 14px;
      padding: 18px;
      position: relative;
      overflow: hidden;
    }
    .slider-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00d9ff, #a55eea);
    }
    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .slider-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      color: #fff;
      font-weight: 600;
    }
    .slider-title .icon {
      font-size: 22px;
      filter: drop-shadow(0 0 5px rgba(0,217,255,0.5));
    }
    .slider-value-box {
      background: rgba(0,217,255,0.15);
      border: 1px solid rgba(0,217,255,0.4);
      border-radius: 8px;
      padding: 6px 14px;
    }
    .slider-value { font-size: 18px; font-weight: 700; color: #00d9ff; }
    input[type="range"] {
      width: 100%;
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(90deg, rgba(0,217,255,0.3), rgba(165,94,234,0.3));
      appearance: none;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #00d9ff, #0090ff);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 12px rgba(0,217,255,0.6);
      border: 2px solid #fff;
    }
    
    .action-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; margin-top: 10px; }
    .action-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .action-title { font-size: 16px; font-weight: 600; }
    .action-title.short { color: #2ed573; }
    .action-title.long { color: #ffa502; }
    .action-disabled { opacity: 0.4; pointer-events: none; }
    
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
    select, input[type="number"] {
      width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 13px; outline: none;
    }
    select:focus, input[type="number"]:focus { border-color: #00d9ff; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    
    .macro-step { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #5352ed; }
    .macro-step.disabled { opacity: 0.5; border-left-color: #444; }
    .macro-step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .macro-step-title { font-size: 13px; font-weight: 600; color: #5352ed; }
    .macro-step.disabled .macro-step-title { color: #666; }
    .modifier-row { display: flex; gap: 15px; margin-top: 10px; }
    .modifier-check { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #aaa; }
    .modifier-check input { width: 16px; height: 16px; accent-color: #00d9ff; }
    
    .log { background: rgba(0,0,0,0.4); border-radius: 8px; padding: 12px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; }
    .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-entry.rx { color: #2ed573; }
    .log-entry.tx { color: #ffa502; }
    .log-entry.info { color: #747d8c; }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .modal-title { font-size: 20px; font-weight: 700; color: #00d9ff; }
    .modal-close { background: none; border: none; color: #888; font-size: 28px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .info-section { margin-bottom: 25px; }
    .info-section-title { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .profile-area { display: flex; gap: 20px; align-items: center; }
    .profile-photo { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; text-align: center; border: 2px dashed rgba(255,255,255,0.2); }
    .profile-name { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
    .profile-desc { font-size: 12px; color: #888; }
    .qr-area { display: flex; justify-content: center; }
    .qr-code { width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; text-align: center; border: 2px dashed rgba(255,255,255,0.2); }
    .manual-text { font-size: 13px; line-height: 1.7; color: #ccc; }
    .manual-text h4 { color: #00d9ff; margin: 12px 0 6px 0; font-size: 14px; }
    .manual-text ul { margin-left: 18px; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="header-bar">
      <div class="header-title" id="devTrigger"><span class="missjo">MISSJO</span> <span class="from">from MARINEBOY</span></div>
      <div class="header-buttons">
        <button class="lang-btn active" id="langKo" onclick="setLanguage('ko')">ğŸ‡°ğŸ‡·</button>
        <button class="lang-btn" id="langEn" onclick="setLanguage('en')">ğŸ‡¬ğŸ‡§</button>
        <button class="info-btn" onclick="openModal()">â„¹ï¸ Info</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title" id="modalTitle">ì •ë³´ ë° ì‚¬ìš©ë²•</span>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="info-section">
            <div class="info-section-title" id="developerLabel">ê°œë°œì</div>
            <div class="profile-area">
              <div class="profile-photo"><span id="photoPlaceholder">ì‚¬ì§„<br>ì¤€ë¹„ì¤‘</span></div>
              <div><div class="profile-name">MBOY</div><div class="profile-desc" id="profileDesc">ì„ë² ë””ë“œ ì‹œìŠ¤í…œ ê°œë°œì</div></div>
            </div>
          </div>
          <div class="info-section">
            <div class="info-section-title" id="qrLabel">QR ì½”ë“œ</div>
            <div class="qr-area"><div class="qr-code"><span id="qrPlaceholder">QRì½”ë“œ<br>ì¤€ë¹„ì¤‘</span></div></div>
          </div>
          <div class="info-section">
            <div class="info-section-title" id="manualLabel">ì‚¬ìš©ë²•</div>
            <div class="manual-text" id="manualContent">
              <h4>1. ì—°ê²°</h4><ul><li>USB ì—°ê²° í›„ "ì—°ê²°" í´ë¦­</li></ul>
              <h4>2. í”„ë¦¬ì…‹</h4><ul><li>í”„ë¦¬ì…‹ ì„ íƒ â†’ ë¶ˆëŸ¬ì˜¤ê¸°</li></ul>
              <h4>3. ë²„íŠ¼ ì„¤ì •</h4><ul><li>ë²„íŠ¼ í´ë¦­ â†’ ì„¤ì • ë³€ê²½ â†’ ì €ì¥</li></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="status-bar">
        <div class="status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">ì—°ê²° ì•ˆë¨</span>
          <span class="unsaved-badge hidden" id="unsavedBadge">ì €ì¥ ì•ˆë¨</span>
        </div>
        <button class="btn btn-connect" id="connectBtn" onclick="toggleConnection()">ì—°ê²°</button>
      </div>
      <div class="btn-row">
        <button class="btn btn-load-device" id="loadDeviceBtn" onclick="loadFromDevice()" disabled><span id="loadDeviceBtnText">ğŸ“¥ ì¥ì¹˜ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</span></button>
        <button class="btn btn-save" id="saveBtn" onclick="saveToDevice()" disabled><span id="saveBtnText">ğŸ’¾ ì¥ì¹˜ì— ì €ì¥</span></button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title"><span id="presetsLabel">í”„ë¦¬ì…‹</span></div>
      <div class="preset-grid" id="presetGrid"></div>
      <div class="preset-actions">
        <button class="btn btn-load" onclick="loadPreset()" id="loadBtn">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">
        <span id="buttonStatusLabel">ë²„íŠ¼ ìƒíƒœ</span>
        <span class="virtual-hint hidden" id="virtualHint">âœ¨ ì‹¤ì œ ë²„íŠ¼ì²˜ëŸ¼ ì‘ë™ë©ë‹ˆë‹¤! ëˆŒëŸ¬ë³´ì„¸ìš”!</span>
        <div class="virtual-toggle">
          <span id="virtualBtnLabel">ê°€ìƒë²„íŠ¼</span>
          <label class="toggle"><input type="checkbox" id="virtualEnabled" onchange="onVirtualToggle()"><span class="toggle-slider"></span></label>
        </div>
      </div>
      <div class="button-grid" id="buttonGrid"></div>
    </div>
    
    <div class="card" id="configCard">
      <div class="card-title"><span id="configTitle">ë²„íŠ¼ ì„¤ì • - <span id="selectedBtnLabel">BTN 1</span></span></div>
      <div class="mode-select">
        <button class="mode-btn active" id="modeSingle" onclick="setMode(0)">ğŸ”˜ <span class="mode-text">ì‹±ê¸€</span></button>
        <button class="mode-btn" id="modeDouble" onclick="setMode(1)">ğŸ”˜ğŸ”˜ <span class="mode-text">ë”ë¸”</span></button>
      </div>
      <div class="action-card">
        <div class="action-header">
          <span class="action-title short">âš¡ Short Press</span>
          <label class="toggle"><input type="checkbox" id="shortEnabled" checked onchange="updateAction('short')"><span class="toggle-slider"></span></label>
        </div>
        <div id="shortSettings">
          <div class="form-group">
            <label class="form-label" id="shortTypeLabel">íƒ€ì…</label>
            <select id="shortType" onchange="onTypeChange('short')">
              <option value="0">âŒ¨ï¸ í‚¤ë³´ë“œ</option><option value="1">ğŸµ ë¯¸ë””ì–´í‚¤</option>
              <option value="2">ğŸ¹ MIDI Note</option><option value="3">ğŸšï¸ MIDI CC</option>
              <option value="4">ğŸ“‹ MIDI PC</option><option value="5">ğŸ“ ë§¤í¬ë¡œ</option>
            </select>
          </div>
          <div id="shortParams"></div>
        </div>
      </div>
      <div class="slider-group hidden" id="longPressGroup">
        <div class="slider-box">
          <div class="slider-header">
            <div class="slider-title">
              <span class="icon">â±ï¸</span>
              <span id="longPressLabel">ë¡±í”„ë ˆìŠ¤ ì‹œê°„</span>
            </div>
            <div class="slider-value-box">
              <span class="slider-value" id="lpTimeValue">1.0 sec</span>
            </div>
          </div>
          <input type="range" id="lpTimeSlider" min="500" max="3000" step="100" value="1000" oninput="updateLongPressTime()">
        </div>
      </div>
      <div class="action-card hidden" id="longActionCard">
        <div class="action-header">
          <span class="action-title long">â³ Long Press</span>
          <label class="toggle"><input type="checkbox" id="longEnabled" checked onchange="updateAction('long')"><span class="toggle-slider"></span></label>
        </div>
        <div id="longSettings">
          <div class="form-group">
            <label class="form-label" id="longTypeLabel">íƒ€ì…</label>
            <select id="longType" onchange="onTypeChange('long')">
              <option value="0">âŒ¨ï¸ í‚¤ë³´ë“œ</option><option value="1">ğŸµ ë¯¸ë””ì–´í‚¤</option>
              <option value="2">ğŸ¹ MIDI Note</option><option value="3">ğŸšï¸ MIDI CC</option>
              <option value="4">ğŸ“‹ MIDI PC</option><option value="5">ğŸ“ ë§¤í¬ë¡œ</option>
            </select>
          </div>
          <div id="longParams"></div>
        </div>
      </div>
    </div>
    
    <div class="card hidden" id="logCard">
      <div class="card-title"><span id="logLabel">ë¡œê·¸</span><span class="dev-badge">ğŸ› ï¸ DEV</span></div>
      <div class="log" id="log"></div>
    </div>
  </div>

<script>
const i18n = {
  ko: { 
    disconnected:'ì—°ê²° ì•ˆë¨', connected:'ì—°ê²°ë¨', unsaved:'ì €ì¥ ì•ˆë¨', connect:'ì—°ê²°', disconnect:'ì—°ê²° í•´ì œ',
    presets:'í”„ë¦¬ì…‹', buttonStatus:'ë²„íŠ¼ ìƒíƒœ', virtualButton:'ê°€ìƒë²„íŠ¼', single:'ì‹±ê¸€', double:'ë”ë¸”',
    short:'S', long:'L', savedToEeprom:'âœ… EEPROMì— ì €ì¥ë¨', connectionFailed:'ì—°ê²° ì‹¤íŒ¨: ',
    key:'í‚¤', mediaKeyLabel:'ë¯¸ë””ì–´ í‚¤', note:'ë…¸íŠ¸', velocity:'ë²¨ë¡œì‹œí‹°', channel:'ì±„ë„',
    ccNumber:'CC #', value:'ê°’', programNumber:'í”„ë¡œê·¸ë¨ #', step:'ìŠ¤í…', delay:'ë”œë ˆì´',
    catAlphabet:'ğŸ”¤ ì•ŒíŒŒë²³', catNumber:'ğŸ”¢ ìˆ«ì', catFkeys:'ğŸ¯ Fí‚¤', catNavigation:'ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜',
    catSpecial:'âš™ï¸ íŠ¹ìˆ˜í‚¤', catPunctuation:'âœï¸ êµ¬ë‘ì ', catSymbols:'ğŸ”£ íŠ¹ìˆ˜ë¬¸ì',
    // ì¶”ê°€ëœ ë²ˆì—­
    saveToDevice:'ğŸ’¾ ì¥ì¹˜ì— ì €ì¥', loadFromDevice:'ğŸ“¥ ì¥ì¹˜ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°', loadPreset:'ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°', buttonConfig:'ë²„íŠ¼ ì„¤ì •',
    longPressTime:'ë¡±í”„ë ˆìŠ¤ ì‹œê°„', type:'íƒ€ì…', log:'ë¡œê·¸',
    keyboard:'âŒ¨ï¸ í‚¤ë³´ë“œ', mediaKey:'ğŸµ ë¯¸ë””ì–´í‚¤', midiNote:'ğŸ¹ MIDI Note', 
    midiCC:'ğŸšï¸ MIDI CC', midiPC:'ğŸ“‹ MIDI PC', macro:'ğŸ“ ë§¤í¬ë¡œ',
    modalTitle:'ì •ë³´ ë° ì‚¬ìš©ë²•', developer:'ê°œë°œì', profileDesc:'ì„ë² ë””ë“œ ì‹œìŠ¤í…œ ê°œë°œì',
    qrCode:'QR ì½”ë“œ', manual:'ì‚¬ìš©ë²•', photoPlaceholder:'ì‚¬ì§„<br>ì¤€ë¹„ì¤‘', qrPlaceholder:'QRì½”ë“œ<br>ì¤€ë¹„ì¤‘',
    manualContent:'<h4>1. ì—°ê²°</h4><ul><li>USB ì—°ê²° í›„ "ì—°ê²°" í´ë¦­</li></ul><h4>2. í”„ë¦¬ì…‹</h4><ul><li>í”„ë¦¬ì…‹ ì„ íƒ â†’ ë¶ˆëŸ¬ì˜¤ê¸°</li></ul><h4>3. ë²„íŠ¼ ì„¤ì •</h4><ul><li>ë²„íŠ¼ í´ë¦­ â†’ ì„¤ì • ë³€ê²½ â†’ ì €ì¥</li></ul>',
    loaded:'ë¶ˆëŸ¬ì˜´', configLoaded:'ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ',
    virtualHint:'âœ¨ ì‹¤ì œ ë²„íŠ¼ì²˜ëŸ¼ ì‘ë™ë©ë‹ˆë‹¤! ëˆŒëŸ¬ë³´ì„¸ìš”!'
  },
  en: { 
    disconnected:'Disconnected', connected:'Connected', unsaved:'Unsaved', connect:'Connect', disconnect:'Disconnect',
    presets:'Presets', buttonStatus:'Button Status', virtualButton:'Virtual Btn', single:'Single', double:'Double',
    short:'S', long:'L', savedToEeprom:'âœ… Saved to EEPROM', connectionFailed:'Connection failed: ',
    key:'Key', mediaKeyLabel:'Media Key', note:'Note', velocity:'Velocity', channel:'Channel',
    ccNumber:'CC #', value:'Value', programNumber:'Program #', step:'Step', delay:'Delay',
    catAlphabet:'ğŸ”¤ Alphabet', catNumber:'ğŸ”¢ Numbers', catFkeys:'ğŸ¯ F-Keys', catNavigation:'ğŸ§­ Navigation',
    catSpecial:'âš™ï¸ Special', catPunctuation:'âœï¸ Punctuation', catSymbols:'ğŸ”£ Symbols',
    // ì¶”ê°€ëœ ë²ˆì—­
    saveToDevice:'ğŸ’¾ Save to Device', loadFromDevice:'ğŸ“¥ Load from Device', loadPreset:'ğŸ“¥ Load', buttonConfig:'Button Config',
    longPressTime:'Long Press Time', type:'Type', log:'Log',
    keyboard:'âŒ¨ï¸ Keyboard', mediaKey:'ğŸµ Media Key', midiNote:'ğŸ¹ MIDI Note', 
    midiCC:'ğŸšï¸ MIDI CC', midiPC:'ğŸ“‹ MIDI PC', macro:'ğŸ“ Macro',
    modalTitle:'Info & Manual', developer:'Developer', profileDesc:'Embedded Systems Developer',
    qrCode:'QR Code', manual:'Manual', photoPlaceholder:'Photo<br>Coming Soon', qrPlaceholder:'QR Code<br>Coming Soon',
    manualContent:'<h4>1. Connect</h4><ul><li>Connect USB, then click "Connect"</li></ul><h4>2. Presets</h4><ul><li>Select preset â†’ Load</li></ul><h4>3. Button Config</h4><ul><li>Click button â†’ Change settings â†’ Save</li></ul>',
    loaded:'loaded', configLoaded:'Config loaded',
    virtualHint:'âœ¨ Works like real buttons! Try clicking!'
  }
};
let currentLang = 'ko';

const keyCategories = {
  alphabet: { name: 'ğŸ”¤ ì•ŒíŒŒë²³', keys: [] },
  number: { name: 'ğŸ”¢ ìˆ«ì', keys: [] },
  fkeys: { name: 'ğŸ¯ Fí‚¤', keys: [{value:194,name:'F1'},{value:195,name:'F2'},{value:196,name:'F3'},{value:197,name:'F4'},{value:198,name:'F5'},{value:199,name:'F6'},{value:200,name:'F7'},{value:201,name:'F8'},{value:202,name:'F9'},{value:203,name:'F10'},{value:204,name:'F11'},{value:205,name:'F12'}] },
  navigation: { name: 'ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜', keys: [{value:218,name:'â†‘'},{value:217,name:'â†“'},{value:216,name:'â†'},{value:215,name:'â†’'},{value:210,name:'Home'},{value:213,name:'End'},{value:211,name:'PgUp'},{value:214,name:'PgDn'}] },
  special: { name: 'âš™ï¸ íŠ¹ìˆ˜í‚¤', keys: [{value:32,name:'Space'},{value:176,name:'Enter'},{value:179,name:'Tab'},{value:177,name:'Backspace'},{value:178,name:'Esc'}] },
  punctuation: { name: 'âœï¸ êµ¬ë‘ì ', keys: [{value:45,name:'-'},{value:61,name:'='},{value:91,name:'['},{value:93,name:']'},{value:92,name:'\\'},{value:59,name:';'},{value:39,name:"'"},{value:44,name:','},{value:46,name:'.'},{value:47,name:'/'}] },
  symbols: { name: 'ğŸ”£ íŠ¹ìˆ˜ë¬¸ì', keys: [{value:33,name:'!'},{value:64,name:'@'},{value:35,name:'#'},{value:36,name:'$'},{value:37,name:'%'},{value:94,name:'^'},{value:38,name:'&'},{value:42,name:'*'},{value:40,name:'('},{value:41,name:')'}] }
};
for(let i=0;i<26;i++) keyCategories.alphabet.keys.push({value:97+i,name:String.fromCharCode(65+i)});
for(let i=0;i<=9;i++) keyCategories.number.keys.push({value:48+i,name:String(i)});

const mediaKeys = [{value:0,name:'â¯ï¸ Play/Pause'},{value:1,name:'â¹ï¸ Stop'},{value:2,name:'â®ï¸ Prev'},{value:3,name:'â­ï¸ Next'},{value:4,name:'ğŸ”Š Vol+'},{value:5,name:'ğŸ”‰ Vol-'},{value:6,name:'ğŸ”‡ Mute'}];

const presets = [
  { icon:'ğŸ”Š', name:'MUSIC_1KEY', buttons:[{m:0,lp:1000,sE:1,sT:1,sV1:0,sV2:0,lE:0,lT:1,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:1,sV1:2,sV2:0,lE:0,lT:1,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:1,sV1:3,sV2:0,lE:0,lT:1,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:1,sV1:5,sV2:0,lE:0,lT:1,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:1,sV1:4,sV2:0,lE:0,lT:1,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:1,sV1:6,sV2:0,lE:0,lT:1,lV1:0,lV2:0}] },
  { icon:'ğŸ¶', name:'MUSIC+MIDI', buttons:[{m:1,lp:1000,sE:1,sT:1,sV1:0,sV2:0,lE:1,lT:2,lV1:61,lV2:127},{m:1,lp:1000,sE:1,sT:1,sV1:2,sV2:0,lE:1,lT:2,lV1:62,lV2:127},{m:1,lp:1000,sE:1,sT:1,sV1:3,sV2:0,lE:1,lT:2,lV1:63,lV2:127},{m:1,lp:1000,sE:1,sT:1,sV1:5,sV2:0,lE:1,lT:2,lV1:64,lV2:127},{m:1,lp:1000,sE:1,sT:1,sV1:4,sV2:0,lE:1,lT:2,lV1:65,lV2:127},{m:1,lp:1000,sE:1,sT:1,sV1:6,sV2:0,lE:1,lT:2,lV1:66,lV2:127}] },
  { icon:'ğŸ¹', name:'MIDI_1KEY', buttons:[{m:0,lp:1000,sE:1,sT:2,sV1:61,sV2:127,lE:0,lT:2,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:2,sV1:62,sV2:127,lE:0,lT:2,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:2,sV1:63,sV2:127,lE:0,lT:2,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:2,sV1:64,sV2:127,lE:0,lT:2,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:2,sV1:65,sV2:127,lE:0,lT:2,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:2,sV1:66,sV2:127,lE:0,lT:2,lV1:0,lV2:0}] },
  { icon:'ğŸ¥', name:'MIDI_2KEY', buttons:[{m:1,lp:1000,sE:1,sT:2,sV1:61,sV2:127,lE:1,lT:2,lV1:71,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:62,sV2:127,lE:1,lT:2,lV1:72,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:63,sV2:127,lE:1,lT:2,lV1:73,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:64,sV2:127,lE:1,lT:2,lV1:74,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:65,sV2:127,lE:1,lT:2,lV1:75,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:66,sV2:127,lE:1,lT:2,lV1:76,lV2:127}] },
  { icon:'ğŸ¯', name:'GoButton', buttons:[{m:1,lp:1000,sE:1,sT:2,sV1:61,sV2:127,lE:1,lT:2,lV1:71,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:62,sV2:127,lE:1,lT:2,lV1:72,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:63,sV2:127,lE:1,lT:2,lV1:73,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:64,sV2:127,lE:1,lT:2,lV1:74,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:65,sV2:127,lE:1,lT:2,lV1:75,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:66,sV2:127,lE:1,lT:2,lV1:76,lV2:127}] },
  { icon:'ğŸ¬', name:'QLAB', buttons:[{m:1,lp:1000,sE:1,sT:0,sV1:32,sV2:0,lE:1,lT:2,lV1:71,lV2:127},{m:1,lp:1000,sE:1,sT:0,sV1:108,sV2:0,lE:1,lT:2,lV1:72,lV2:127},{m:1,lp:1000,sE:1,sT:0,sV1:115,sV2:0,lE:1,lT:2,lV1:73,lV2:127},{m:1,lp:1000,sE:1,sT:0,sV1:112,sV2:0,lE:1,lT:2,lV1:74,lV2:127},{m:1,lp:1000,sE:1,sT:0,sV1:91,sV2:0,lE:1,lT:2,lV1:75,lV2:127},{m:1,lp:1000,sE:1,sT:0,sV1:93,sV2:0,lE:1,lT:2,lV1:76,lV2:127}] },
  { icon:'ğŸ–¥ï¸', name:'PPT', buttons:[{m:0,lp:1000,sE:1,sT:0,sV1:215,sV2:0,lE:0,lT:0,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:0,sV1:216,sV2:0,lE:0,lT:0,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:0,sV1:198,sV2:0,lE:0,lT:0,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:0,sV1:178,sV2:0,lE:0,lT:0,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:0,sV1:98,sV2:0,lE:0,lT:0,lV1:0,lV2:0},{m:0,lp:1000,sE:1,sT:0,sV1:119,sV2:0,lE:0,lT:0,lV1:0,lV2:0}] },
  { icon:'ğŸ”¢', name:'Number', buttons:[{m:1,lp:1000,sE:1,sT:0,sV1:49,sV2:0,lE:1,lT:0,lV1:55,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:50,sV2:0,lE:1,lT:0,lV1:56,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:51,sV2:0,lE:1,lT:0,lV1:57,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:52,sV2:0,lE:1,lT:0,lV1:48,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:53,sV2:0,lE:1,lT:0,lV1:46,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:54,sV2:0,lE:1,lT:0,lV1:44,lV2:0}] },
  { icon:'ğŸ‘ğŸ¼', name:'CustomKEY', buttons:[{m:1,lp:1000,sE:1,sT:0,sV1:97,sV2:0,lE:1,lT:0,lV1:103,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:98,sV2:0,lE:1,lT:0,lV1:104,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:99,sV2:0,lE:1,lT:0,lV1:105,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:100,sV2:0,lE:1,lT:0,lV1:106,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:101,sV2:0,lE:1,lT:0,lV1:107,lV2:0},{m:1,lp:1000,sE:1,sT:0,sV1:102,sV2:0,lE:1,lT:0,lV1:108,lV2:0}] },
  { icon:'ğŸ‘¶ğŸ»', name:'CustomMIDI', buttons:[{m:1,lp:1000,sE:1,sT:2,sV1:41,sV2:127,lE:1,lT:2,lV1:51,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:42,sV2:127,lE:1,lT:2,lV1:52,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:43,sV2:127,lE:1,lT:2,lV1:53,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:44,sV2:127,lE:1,lT:2,lV1:54,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:45,sV2:127,lE:1,lT:2,lV1:55,lV2:127},{m:1,lp:1000,sE:1,sT:2,sV1:46,sV2:127,lE:1,lT:2,lV1:56,lV2:127}] }
];

let port=null, reader=null, writer=null, sendTimeout=null;
let selectedPreset=0, selectedBtn=0, virtualTimer=null;

let buttons = [];
for(let i=0;i<6;i++){
  buttons.push({ mode:0, longPressTime:1000, shortEnabled:1, shortType:1, shortValue1:0, shortValue2:0, shortChannel:1,
    shortMacro:[{delay:1000,type:0,value1:0,value2:0,value3:1},{delay:1000,type:0,value1:0,value2:0,value3:1},{delay:1000,type:0,value1:0,value2:0,value3:1}],
    longEnabled:1, longType:1, longValue1:0, longValue2:0, longChannel:1,
    longMacro:[{delay:1000,type:0,value1:0,value2:0,value3:1},{delay:1000,type:0,value1:0,value2:0,value3:1},{delay:1000,type:0,value1:0,value2:0,value3:1}] });
}

function init(){
  if(!('serial' in navigator)){ document.getElementById('app').innerHTML='<div class="card" style="text-align:center;padding:50px;"><h2 style="color:#ff4757">âš ï¸ Web Serial Not Supported</h2><p>Please use Chrome/Edge.</p></div>'; return; }
  const lang = localStorage.getItem('proMicroLang')||'ko'; setLanguage(lang);
  renderPresets(); renderButtonGrid(); selectButton(0);
  initDevMode();
}

// ê°œë°œì ëª¨ë“œ (MISSJO 7ì´ˆ ë¡±í”„ë ˆìŠ¤)
let devMode = false;
let devPressTimer = null;

function initDevMode() {
  const trigger = document.getElementById('devTrigger');
  trigger.addEventListener('mousedown', startDevPress);
  trigger.addEventListener('mouseup', cancelDevPress);
  trigger.addEventListener('mouseleave', cancelDevPress);
  trigger.addEventListener('touchstart', startDevPress);
  trigger.addEventListener('touchend', cancelDevPress);
}

function startDevPress(e) {
  e.preventDefault();
  devPressTimer = setTimeout(() => {
    devMode = !devMode;
    document.getElementById('logCard').classList.toggle('hidden', !devMode);
    if(devMode) {
      log('ğŸ› ï¸ ê°œë°œì ëª¨ë“œ í™œì„±í™”', 'info');
    }
  }, 7000);
}

function cancelDevPress() {
  if(devPressTimer) {
    clearTimeout(devPressTimer);
    devPressTimer = null;
  }
}

function setLanguage(lang){
  currentLang=lang;
  const t = i18n[lang];
  
  // ì–¸ì–´ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ
  document.getElementById('langKo').classList.toggle('active',lang==='ko');
  document.getElementById('langEn').classList.toggle('active',lang==='en');
  
  // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì—…ë°ì´íŠ¸
  keyCategories.alphabet.name=t.catAlphabet; 
  keyCategories.number.name=t.catNumber;
  keyCategories.fkeys.name=t.catFkeys; 
  keyCategories.navigation.name=t.catNavigation;
  keyCategories.special.name=t.catSpecial; 
  keyCategories.punctuation.name=t.catPunctuation;
  keyCategories.symbols.name=t.catSymbols;
  
  // ìƒíƒœ í‘œì‹œ
  document.getElementById('statusText').textContent = port ? t.connected : t.disconnected;
  document.getElementById('unsavedBadge').textContent = t.unsaved;
  document.getElementById('connectBtn').textContent = port ? t.disconnect : t.connect;
  
  // ë©”ì¸ UI í…ìŠ¤íŠ¸
  document.getElementById('loadDeviceBtnText').textContent = t.loadFromDevice;
  document.getElementById('saveBtnText').textContent = t.saveToDevice;
  document.getElementById('presetsLabel').textContent = t.presets;
  document.getElementById('loadBtn').textContent = t.loadPreset;
  document.getElementById('buttonStatusLabel').textContent = t.buttonStatus;
  document.getElementById('virtualBtnLabel').textContent = t.virtualButton;
  document.getElementById('virtualHint').textContent = t.virtualHint;
  document.getElementById('configTitle').innerHTML = t.buttonConfig + ' - <span id="selectedBtnLabel">BTN ' + (selectedBtn+1) + '</span>';
  document.getElementById('longPressLabel').textContent = t.longPressTime;
  document.getElementById('logLabel').textContent = t.log;
  
  // ëª¨ë“œ ë²„íŠ¼
  document.querySelectorAll('.mode-text').forEach((el, idx) => {
    el.textContent = idx === 0 ? t.single : t.double;
  });
  
  // íƒ€ì… ë¼ë²¨
  document.getElementById('shortTypeLabel').textContent = t.type;
  document.getElementById('longTypeLabel').textContent = t.type;
  
  // íƒ€ì… select ì˜µì…˜
  updateTypeOptions('shortType');
  updateTypeOptions('longType');
  
  // ëª¨ë‹¬
  document.getElementById('modalTitle').textContent = t.modalTitle;
  document.getElementById('developerLabel').textContent = t.developer;
  document.getElementById('profileDesc').textContent = t.profileDesc;
  document.getElementById('qrLabel').textContent = t.qrCode;
  document.getElementById('manualLabel').textContent = t.manual;
  document.getElementById('photoPlaceholder').innerHTML = t.photoPlaceholder;
  document.getElementById('qrPlaceholder').innerHTML = t.qrPlaceholder;
  document.getElementById('manualContent').innerHTML = t.manualContent;
  
  localStorage.setItem('proMicroLang',lang);
  renderButtonGrid(); 
  renderParams('short'); 
  renderParams('long');
}

function updateTypeOptions(selectId) {
  const t = i18n[currentLang];
  const select = document.getElementById(selectId);
  if (!select) return;
  const currentValue = select.value;
  select.innerHTML = `
    <option value="0">${t.keyboard}</option>
    <option value="1">${t.mediaKey}</option>
    <option value="2">${t.midiNote}</option>
    <option value="3">${t.midiCC}</option>
    <option value="4">${t.midiPC}</option>
    <option value="5">${t.macro}</option>
  `;
  select.value = currentValue;
}

function openModal(){ document.getElementById('modalOverlay').classList.add('show'); }
function closeModal(){ document.getElementById('modalOverlay').classList.remove('show'); }
function closeModalOutside(e){ if(e.target.id==='modalOverlay')closeModal(); }

function renderPresets(){
  document.getElementById('presetGrid').innerHTML = presets.map((p,i)=>`<div class="preset-box ${i===selectedPreset?'selected':''}" onclick="selectPreset(${i})"><div class="preset-icon">${p.icon}</div><div class="preset-name">${p.name}</div></div>`).join('');
}
function selectPreset(i){ selectedPreset=i; renderPresets(); }
function loadPreset(){
  const p=presets[selectedPreset];
  const t=i18n[currentLang];
  for(let i=0;i<6;i++){ const b=p.buttons[i]; buttons[i].mode=b.m; buttons[i].longPressTime=b.lp; buttons[i].shortEnabled=b.sE; buttons[i].shortType=b.sT; buttons[i].shortValue1=b.sV1; buttons[i].shortValue2=b.sV2; buttons[i].longEnabled=b.lE; buttons[i].longType=b.lT; buttons[i].longValue1=b.lV1; buttons[i].longValue2=b.lV2; }
  renderButtonGrid(); selectButton(selectedBtn); setUnsaved(true); log('ğŸ“¥ '+p.name+' '+t.loaded,'info');
}

function renderButtonGrid(){
  const t=i18n[currentLang];
  document.getElementById('buttonGrid').innerHTML = buttons.map((b,i)=>`
    <div class="button-box ${i===selectedBtn?'selected':''}" id="btnBox${i}" onclick="selectButton(${i})" onmousedown="virtualDown(${i})" onmouseup="virtualUp(${i})" onmouseleave="virtualUp(${i})">
      <div class="button-box-header"><span class="button-number">BTN ${i+1}</span><span class="button-mode-badge ${b.mode===0?'single':'double'}">${b.mode===0?t.single:t.double}</span></div>
      <div class="button-info">
        <div class="button-info-row"><span class="button-info-label">${t.short}:</span><span class="button-info-value">${getActionLabel(b,'short')}</span></div>
        ${b.mode===1?`<div class="button-info-row"><span class="button-info-label">${t.long}:</span><span class="button-info-value">${getActionLabel(b,'long')}</span></div>`:''}
      </div>
    </div>`).join('');
}

function getActionLabel(b,type){
  const t=i18n[currentLang];
  const en=type==='short'?b.shortEnabled:b.longEnabled;
  const actionType=type==='short'?b.shortType:b.longType;
  const v1=type==='short'?b.shortValue1:b.longValue1;
  const v2=type==='short'?b.shortValue2:b.longValue2;
  const ch=type==='short'?b.shortChannel:b.longChannel;
  if(!en)return'â€”';
  
  // í‚¤ë³´ë“œ
  if(actionType===0){
    let mods = '';
    if(v2 & 1) mods += 'Ctrl+';
    if(v2 & 2) mods += 'Alt+';
    if(v2 & 4) mods += 'Shift+';
    if(v2 & 8) mods += 'Win+';
    return mods + getKeyName(v1);
  }
  // ë¯¸ë””ì–´í‚¤ - ì „ì²´ ì´ë¦„ í‘œì‹œ
  if(actionType===1) return mediaKeys[v1]?.name || '?';
  // MIDI Note - ë…¸íŠ¸, ë²¨ë¡œì‹œí‹°, ì±„ë„
  if(actionType===2) return 'Note:'+v1+' Vel:'+v2+' Ch:'+ch;
  // MIDI CC - CCë²ˆí˜¸, ê°’, ì±„ë„
  if(actionType===3) return 'CC:'+v1+' Val:'+v2+' Ch:'+ch;
  // MIDI PC - í”„ë¡œê·¸ë¨ë²ˆí˜¸, ì±„ë„
  if(actionType===4) return 'PC:'+v1+' Ch:'+ch;
  // ë§¤í¬ë¡œ
  if(actionType===5) return t.macro.replace('ğŸ“ ','');
  return'?';
}
function getKeyName(code){ for(const c of Object.values(keyCategories)){const k=c.keys.find(k=>k.value===code);if(k)return k.name;} return String.fromCharCode(code); }

function selectButton(i){ 
  selectedBtn=i; 
  const t=i18n[currentLang];
  document.getElementById('configTitle').innerHTML = t.buttonConfig + ' - <span id="selectedBtnLabel">BTN '+(i+1)+'</span>';
  renderButtonGrid(); 
  updateConfigUI(); 
}

function onVirtualToggle(){
  const enabled = document.getElementById('virtualEnabled').checked;
  const hint = document.getElementById('virtualHint');
  const t = i18n[currentLang];
  hint.textContent = t.virtualHint;
  hint.classList.toggle('hidden', !enabled);
}

function virtualDown(i){
  if(!document.getElementById('virtualEnabled').checked)return;
  document.getElementById('btnBox'+i).classList.add('virtual-active');
  virtualTimer=setTimeout(()=>{ 
    if(buttons[i].mode===1) sendCommand('BTN:'+i+':L'); 
    virtualTimer=null;  // ë¡±í”„ë ˆìŠ¤ ì‹¤í–‰ í›„ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
  },buttons[i].longPressTime);
}
function virtualUp(i){
  if(!document.getElementById('virtualEnabled').checked)return;
  document.getElementById('btnBox'+i)?.classList.remove('virtual-active');
  if(virtualTimer){clearTimeout(virtualTimer);sendCommand('BTN:'+i+':S');virtualTimer=null;}
}

function updateConfigUI(){
  const b=buttons[selectedBtn];
  const t=i18n[currentLang];
  document.getElementById('modeSingle').classList.toggle('active',b.mode===0);
  document.getElementById('modeDouble').classList.toggle('active',b.mode===1);
  document.getElementById('longPressGroup').classList.toggle('hidden',b.mode===0);
  document.getElementById('longActionCard').classList.toggle('hidden',b.mode===0);
  document.getElementById('lpTimeSlider').value=b.longPressTime;
  document.getElementById('lpTimeValue').textContent=(b.longPressTime/1000).toFixed(1)+' sec';
  document.getElementById('shortEnabled').checked=b.shortEnabled;
  document.getElementById('shortType').value=b.shortType;
  document.getElementById('shortSettings').classList.toggle('action-disabled',!b.shortEnabled);
  document.getElementById('longEnabled').checked=b.longEnabled;
  document.getElementById('longType').value=b.longType;
  document.getElementById('longSettings').classList.toggle('action-disabled',!b.longEnabled);
  renderParams('short'); renderParams('long');
}

function setMode(m){ buttons[selectedBtn].mode=m; updateConfigUI(); renderButtonGrid(); sendConfigDelayed(); }
function updateLongPressTime(){ buttons[selectedBtn].longPressTime=parseInt(document.getElementById('lpTimeSlider').value); document.getElementById('lpTimeValue').textContent=(buttons[selectedBtn].longPressTime/1000).toFixed(1)+' sec'; sendConfigDelayed(); }
function onTypeChange(prefix){ const b=buttons[selectedBtn]; const actionType=parseInt(document.getElementById(prefix+'Type').value); if(prefix==='short'){b.shortType=actionType;b.shortValue1=actionType===2?61:0;b.shortValue2=actionType===2?127:0;}else{b.longType=actionType;b.longValue1=actionType===2?61:0;b.longValue2=actionType===2?127:0;} renderParams(prefix); renderButtonGrid(); sendConfigDelayed(); }
function updateAction(prefix){ const b=buttons[selectedBtn]; const en=document.getElementById(prefix+'Enabled').checked?1:0; const actionType=parseInt(document.getElementById(prefix+'Type').value); const v1=document.getElementById(prefix+'Value1'); const v2=document.getElementById(prefix+'Value2'); const ch=document.getElementById(prefix+'Channel'); if(prefix==='short'){b.shortEnabled=en;b.shortType=actionType;if(v1)b.shortValue1=parseInt(v1.value)||0;if(v2)b.shortValue2=parseInt(v2.value)||0;if(ch)b.shortChannel=parseInt(ch.value)||1;document.getElementById('shortSettings').classList.toggle('action-disabled',!en);}else{b.longEnabled=en;b.longType=actionType;if(v1)b.longValue1=parseInt(v1.value)||0;if(v2)b.longValue2=parseInt(v2.value)||0;if(ch)b.longChannel=parseInt(ch.value)||1;document.getElementById('longSettings').classList.toggle('action-disabled',!en);} renderButtonGrid(); sendConfigDelayed(); }

function renderParams(prefix){
  const b=buttons[selectedBtn]; const t=i18n[currentLang]; const actionType=parseInt(document.getElementById(prefix+'Type').value);
  const v1=prefix==='short'?b.shortValue1:b.longValue1; const v2=prefix==='short'?b.shortValue2:b.longValue2; const ch=prefix==='short'?b.shortChannel:b.longChannel;
  const macro=prefix==='short'?b.shortMacro:b.longMacro; let html='';
  if(actionType===0){ let opts=''; for(const c of Object.values(keyCategories)){opts+=`<optgroup label="${c.name}">${c.keys.map(k=>`<option value="${k.value}" ${k.value===v1?'selected':''}>${k.name}</option>`).join('')}</optgroup>`;} html=`<div class="form-group"><label class="form-label">${t.key}</label><select id="${prefix}Value1" onchange="updateAction('${prefix}')">${opts}</select></div>`; }
  else if(actionType===1){ html=`<div class="form-group"><label class="form-label">${t.mediaKeyLabel}</label><select id="${prefix}Value1" onchange="updateAction('${prefix}')">${mediaKeys.map(k=>`<option value="${k.value}" ${k.value===v1?'selected':''}>${k.name}</option>`).join('')}</select></div>`; }
  else if(actionType===2){ html=`<div class="form-row-3"><div class="form-group"><label class="form-label">${t.note}</label><input type="number" id="${prefix}Value1" min="0" max="127" value="${v1}" oninput="updateAction('${prefix}')"></div><div class="form-group"><label class="form-label">${t.velocity}</label><input type="number" id="${prefix}Value2" min="0" max="127" value="${v2}" oninput="updateAction('${prefix}')"></div><div class="form-group"><label class="form-label">${t.channel}</label><input type="number" id="${prefix}Channel" min="1" max="16" value="${ch}" oninput="updateAction('${prefix}')"></div></div>`; }
  else if(actionType===3){ html=`<div class="form-row-3"><div class="form-group"><label class="form-label">${t.ccNumber}</label><input type="number" id="${prefix}Value1" min="0" max="127" value="${v1}" oninput="updateAction('${prefix}')"></div><div class="form-group"><label class="form-label">${t.value}</label><input type="number" id="${prefix}Value2" min="0" max="127" value="${v2}" oninput="updateAction('${prefix}')"></div><div class="form-group"><label class="form-label">${t.channel}</label><input type="number" id="${prefix}Channel" min="1" max="16" value="${ch}" oninput="updateAction('${prefix}')"></div></div>`; }
  else if(actionType===4){ html=`<div class="form-row"><div class="form-group"><label class="form-label">${t.programNumber}</label><input type="number" id="${prefix}Value1" min="0" max="127" value="${v1}" oninput="updateAction('${prefix}')"></div><div class="form-group"><label class="form-label">${t.channel}</label><input type="number" id="${prefix}Channel" min="1" max="16" value="${ch}" oninput="updateAction('${prefix}')"></div></div>`; }
  else if(actionType===5){ html=renderMacroEditor(prefix,macro); }
  document.getElementById(prefix+'Params').innerHTML=html;
}

function renderMacroEditor(prefix,macro){
  const t=i18n[currentLang]; let html='<div class="macro-container">';
  for(let i=0;i<3;i++){ const s=macro[i]; const en=s.type>0; const sid=`${prefix}_step_${i}`;
    html+=`<div class="macro-step ${en?'':'disabled'}" id="${sid}_container"><div class="macro-step-header"><span class="macro-step-title">${t.step} ${i+1}</span><label class="toggle" style="transform:scale(0.8)"><input type="checkbox" id="${sid}_enabled" ${en?'checked':''} onchange="toggleMacroStep('${prefix}',${i})"><span class="toggle-slider"></span></label></div><div class="macro-step-content" id="${sid}_content" ${en?'':'style="display:none"'}><div class="form-group"><div class="slider-label"><span>${t.delay}</span><span class="slider-value" id="${sid}_delay_value">${(s.delay/1000).toFixed(1)} sec</span></div><input type="range" id="${sid}_delay" min="0" max="5000" step="100" value="${s.delay}" oninput="updateMacroDelay('${prefix}',${i})"></div><div class="form-group"><label class="form-label">${t.type}</label><select id="${sid}_type" onchange="onMacroTypeChange('${prefix}',${i})"><option value="1" ${s.type===1?'selected':''}>${t.keyboard}</option><option value="2" ${s.type===2?'selected':''}>${t.mediaKey}</option><option value="3" ${s.type===3?'selected':''}>${t.midiNote}</option><option value="4" ${s.type===4?'selected':''}>${t.midiCC}</option><option value="5" ${s.type===5?'selected':''}>${t.midiPC}</option></select></div><div id="${sid}_params">${renderMacroStepParams(prefix,i,s)}</div></div></div>`;
  }
  return html+'</div>';
}
function renderMacroStepParams(prefix,idx,s){
  const sid=`${prefix}_step_${idx}`; const t=i18n[currentLang];
  if(s.type===1){ let opts=''; for(const c of Object.values(keyCategories)){opts+=`<optgroup label="${c.name}">${c.keys.map(k=>`<option value="${k.value}" ${k.value===s.value1?'selected':''}>${k.name}</option>`).join('')}</optgroup>`;} return`<div class="form-group"><label class="form-label">${t.key}</label><select id="${sid}_value1" onchange="updateMacroValue('${prefix}',${idx})">${opts}</select></div><div class="modifier-row"><label class="modifier-check"><input type="checkbox" id="${sid}_ctrl" ${s.value2&1?'checked':''} onchange="updateMacroMod('${prefix}',${idx})">Ctrl</label><label class="modifier-check"><input type="checkbox" id="${sid}_alt" ${s.value2&2?'checked':''} onchange="updateMacroMod('${prefix}',${idx})">Alt</label><label class="modifier-check"><input type="checkbox" id="${sid}_shift" ${s.value2&4?'checked':''} onchange="updateMacroMod('${prefix}',${idx})">Shift</label><label class="modifier-check"><input type="checkbox" id="${sid}_gui" ${s.value2&8?'checked':''} onchange="updateMacroMod('${prefix}',${idx})">Win</label></div>`; }
  if(s.type===2){ return`<div class="form-group"><label class="form-label">${t.mediaKeyLabel}</label><select id="${sid}_value1" onchange="updateMacroValue('${prefix}',${idx})">${mediaKeys.map(k=>`<option value="${k.value}" ${k.value===s.value1?'selected':''}>${k.name}</option>`).join('')}</select></div>`; }
  if(s.type===3){ return`<div class="form-row-3"><div class="form-group"><label class="form-label">${t.note}</label><input type="number" id="${sid}_value1" min="0" max="127" value="${s.value1}" oninput="updateMacroValue('${prefix}',${idx})"></div><div class="form-group"><label class="form-label">${t.velocity}</label><input type="number" id="${sid}_value2" min="0" max="127" value="${s.value2}" oninput="updateMacroValue('${prefix}',${idx})"></div><div class="form-group"><label class="form-label">${t.channel}</label><input type="number" id="${sid}_value3" min="1" max="16" value="${s.value3}" oninput="updateMacroValue('${prefix}',${idx})"></div></div>`; }
  if(s.type===4){ return`<div class="form-row-3"><div class="form-group"><label class="form-label">${t.ccNumber}</label><input type="number" id="${sid}_value1" min="0" max="127" value="${s.value1}" oninput="updateMacroValue('${prefix}',${idx})"></div><div class="form-group"><label class="form-label">${t.value}</label><input type="number" id="${sid}_value2" min="0" max="127" value="${s.value2}" oninput="updateMacroValue('${prefix}',${idx})"></div><div class="form-group"><label class="form-label">${t.channel}</label><input type="number" id="${sid}_value3" min="1" max="16" value="${s.value3}" oninput="updateMacroValue('${prefix}',${idx})"></div></div>`; }
  if(s.type===5){ return`<div class="form-row"><div class="form-group"><label class="form-label">${t.programNumber}</label><input type="number" id="${sid}_value1" min="0" max="127" value="${s.value1}" oninput="updateMacroValue('${prefix}',${idx})"></div><div class="form-group"><label class="form-label">${t.channel}</label><input type="number" id="${sid}_value3" min="1" max="16" value="${s.value3}" oninput="updateMacroValue('${prefix}',${idx})"></div></div>`; }
  return'';
}

function toggleMacroStep(prefix,idx){ const b=buttons[selectedBtn]; const m=prefix==='short'?b.shortMacro:b.longMacro; const sid=`${prefix}_step_${idx}`; const cb=document.getElementById(`${sid}_enabled`); const cont=document.getElementById(`${sid}_container`); const content=document.getElementById(`${sid}_content`); if(cb.checked){m[idx].type=1;m[idx].delay=1000;m[idx].value1=97;m[idx].value2=0;m[idx].value3=1;cont.classList.remove('disabled');content.style.display='';}else{m[idx].type=0;cont.classList.add('disabled');content.style.display='none';} document.getElementById(`${sid}_params`).innerHTML=renderMacroStepParams(prefix,idx,m[idx]); const ds=document.getElementById(`${sid}_delay`); const dv=document.getElementById(`${sid}_delay_value`); if(ds&&dv){ds.value=m[idx].delay;dv.textContent=(m[idx].delay/1000).toFixed(1)+' sec';} sendConfigDelayed(); }
function onMacroTypeChange(prefix,idx){ const b=buttons[selectedBtn]; const m=prefix==='short'?b.shortMacro:b.longMacro; const sid=`${prefix}_step_${idx}`; m[idx].type=parseInt(document.getElementById(`${sid}_type`).value); m[idx].value1=m[idx].type===3?61:0;m[idx].value2=m[idx].type===3?127:0;m[idx].value3=1; document.getElementById(`${sid}_params`).innerHTML=renderMacroStepParams(prefix,idx,m[idx]); sendConfigDelayed(); }
function updateMacroDelay(prefix,idx){ const b=buttons[selectedBtn]; const m=prefix==='short'?b.shortMacro:b.longMacro; const sid=`${prefix}_step_${idx}`; m[idx].delay=parseInt(document.getElementById(`${sid}_delay`).value); document.getElementById(`${sid}_delay_value`).textContent=(m[idx].delay/1000).toFixed(1)+' sec'; sendConfigDelayed(); }
function updateMacroValue(prefix,idx){ const b=buttons[selectedBtn]; const m=prefix==='short'?b.shortMacro:b.longMacro; const sid=`${prefix}_step_${idx}`; const v1=document.getElementById(`${sid}_value1`); const v2=document.getElementById(`${sid}_value2`); const v3=document.getElementById(`${sid}_value3`); if(v1)m[idx].value1=parseInt(v1.value)||0; if(v2)m[idx].value2=parseInt(v2.value)||0; if(v3)m[idx].value3=parseInt(v3.value)||1; sendConfigDelayed(); }
function updateMacroMod(prefix,idx){ const b=buttons[selectedBtn]; const m=prefix==='short'?b.shortMacro:b.longMacro; const sid=`${prefix}_step_${idx}`; let mod=0; if(document.getElementById(`${sid}_ctrl`)?.checked)mod|=1; if(document.getElementById(`${sid}_alt`)?.checked)mod|=2; if(document.getElementById(`${sid}_shift`)?.checked)mod|=4; if(document.getElementById(`${sid}_gui`)?.checked)mod|=8; m[idx].value2=mod; sendConfigDelayed(); }

async function toggleConnection(){ port?await disconnect():await connect(); }
async function connect(){ 
  const t=i18n[currentLang];
  try{ 
    port=await navigator.serial.requestPort(); 
    await port.open({baudRate:115200}); 
    log(t.connected+'!','info'); 
    updateConnectionUI(true); 
    const enc=new TextEncoderStream();enc.readable.pipeTo(port.writable);writer=enc.writable.getWriter(); 
    const dec=new TextDecoderStream();port.readable.pipeTo(dec.writable);reader=dec.readable.getReader(); 
    setTimeout(()=>sendCommand('GET'),500); 
    readLoop(); 
  }catch(e){log(t.connectionFailed+e.message,'info');} 
}
async function disconnect(){ 
  const t=i18n[currentLang];
  try{
    if(reader){await reader.cancel();reader=null;}
    if(writer){await writer.close();writer=null;}
    if(port){await port.close();port=null;}
    log(t.disconnected,'info');
    updateConnectionUI(false);
  }catch(e){} 
}
function updateConnectionUI(c){ 
  const t=i18n[currentLang]; 
  document.getElementById('statusDot').classList.toggle('connected',c); 
  document.getElementById('statusText').textContent=c?t.connected:t.disconnected; 
  const btn=document.getElementById('connectBtn'); 
  btn.textContent=c?t.disconnect:t.connect; 
  btn.className='btn '+(c?'btn-disconnect':'btn-connect'); 
  document.getElementById('loadDeviceBtn').disabled=!c;
  document.getElementById('saveBtn').disabled=!c; 
  if(!c)setUnsaved(false); 
}
async function readLoop(){ let buf=''; try{while(true){const{value,done}=await reader.read();if(done)break;buf+=value;const lines=buf.split('\n');buf=lines.pop();for(const l of lines){const tr=l.trim();if(tr)processResponse(tr);}}}catch(e){} }
function processResponse(r){ 
  const t=i18n[currentLang];
  log('â† '+r,'rx'); 
  if(r==='SAVED'){setUnsaved(false);log(t.savedToEeprom,'info');} 
  else if(r.startsWith('CFG:')){
    const parts=r.substring(4).split(',').map(x=>parseInt(x));
    if(parts.length>=13){
      const i=parts[0];
      if(i>=0 && i<6){
        buttons[i].mode=parts[1];
        buttons[i].longPressTime=parts[2];
        buttons[i].shortEnabled=parts[3];
        buttons[i].shortType=parts[4];
        buttons[i].shortValue1=parts[5];
        buttons[i].shortValue2=parts[6];
        buttons[i].shortChannel=parts[7];
        buttons[i].longEnabled=parts[8];
        buttons[i].longType=parts[9];
        buttons[i].longValue1=parts[10];
        buttons[i].longValue2=parts[11];
        buttons[i].longChannel=parts[12];
        renderButtonGrid(); updateConfigUI(); 
        log('âœ… BTN'+(i+1)+' '+t.configLoaded,'info');
      }
    }
  }
  else if(r.startsWith('MCFG:')){
    const parts=r.substring(5).split(',').map(x=>parseInt(x));
    if(parts.length>=8){
      const btnIdx=parts[0], isShort=parts[1], stepIdx=parts[2];
      if(btnIdx>=0 && btnIdx<6 && stepIdx>=0 && stepIdx<3){
        const m=isShort ? buttons[btnIdx].shortMacro : buttons[btnIdx].longMacro;
        m[stepIdx].delay=parts[3];
        m[stepIdx].type=parts[4];
        m[stepIdx].value1=parts[5];
        m[stepIdx].value2=parts[6];
        m[stepIdx].value3=parts[7];
        renderButtonGrid(); updateConfigUI();
      }
    }
  }
}
async function sendCommand(cmd){ if(!writer)return; try{await writer.write(cmd+'\n');log('â†’ '+cmd,'tx');}catch(e){} }
function sendConfigDelayed(){ clearTimeout(sendTimeout); sendTimeout=setTimeout(()=>{sendAllConfig();setUnsaved(true);},300); }
function sendAllConfig(){ 
  for(let i=0;i<6;i++){ 
    const b=buttons[i]; 
    let cmd=`CFG:${i},${b.mode},${b.longPressTime},${b.shortEnabled},${b.shortType},${b.shortValue1},${b.shortValue2},${b.shortChannel},${b.longEnabled},${b.longType},${b.longValue1},${b.longValue2},${b.longChannel}`; 
    sendCommand(cmd);
    for(let j=0;j<3;j++){
      if(b.shortMacro[j].type>0){
        const m=b.shortMacro[j];
        sendCommand(`MCFG:${i},1,${j},${m.delay},${m.type},${m.value1},${m.value2},${m.value3}`);
      }
      if(b.longMacro[j].type>0){
        const m=b.longMacro[j];
        sendCommand(`MCFG:${i},0,${j},${m.delay},${m.type},${m.value1},${m.value2},${m.value3}`);
      }
    }
  } 
}
async function saveToDevice(){ if(!writer)return; clearTimeout(sendTimeout); await sendCommand('SAVE'); }
async function loadFromDevice(){ 
  if(!writer)return; 
  const t=i18n[currentLang];
  log('ğŸ“¥ '+(currentLang==='ko'?'ì¥ì¹˜ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...':'Loading config from device...'),'info');
  await sendCommand('GET'); 
  setUnsaved(false);
}
function setUnsaved(v){ 
  const t=i18n[currentLang];
  document.getElementById('unsavedBadge').classList.toggle('hidden',!v); 
  document.getElementById('unsavedBadge').textContent=t.unsaved;
  document.getElementById('saveBtn').classList.toggle('unsaved',v); 
}
function log(msg,type='info'){ const d=document.getElementById('log'); const e=document.createElement('div'); e.className='log-entry '+type; e.textContent='['+new Date().toLocaleTimeString()+'] '+msg; d.appendChild(e); d.scrollTop=d.scrollHeight; }

init();
</script>
</body>
</html>
